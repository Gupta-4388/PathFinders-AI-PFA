/**
 * This ruleset enforces a strict user-ownership security model for the PathFinder AI application.
 *
 * Core Philosophy:
 * Access is granted based on a user-centric, hierarchical data structure. Every authenticated user can
 * create and manage their own data, but they are strictly prohibited from accessing, viewing, or modifying
 * the data of any other user. The default security posture is to deny all access unless explicitly granted.
 *
 * Data Structure:
 * All user-specific data, including resumes, AI mentor feedback, and career dashboards, is organized
 * in subcollections nested under the path `/users/{userId}`. This structure makes ownership clear and
 * allows security rules to leverage the document path for efficient and secure authorization.
 *
 * Key Security Decisions:
 * - Strict Ownership: All data is private. A user can only access documents located within their own
 *   data tree (i.e., where `{userId}` in the path matches their authenticated UID).
 * - No Public Access: There are no globally readable collections.
 * - User Enumeration Disabled: Listing documents from the top-level `/users` collection is explicitly
 *   disallowed to protect user privacy and prevent data scraping.
 * - Relational Integrity: On document creation, rules validate that the internal `userId` or `id` field
 *   matches the `userId` from the document path, ensuring data consistency. These key relational fields

 *   are enforced as immutable on update.
 *
 * Denormalization for Authorization:
 * This ruleset leverages path-based authorization. By nesting all data under `/users/{userId}`, the user's
 * ID is part of the path to every document they own. This eliminates the need for costly `get()` calls or
 * denormalizing ownership fields just for security rules, leading to simpler, faster, and more secure logic.
 *
 * Structural Segregation:
 * The data model naturally segregates each user's data into its own document tree. This is the most secure
 * and performant way to manage private user data, as it makes it impossible for queries to accidentally
 * leak data belonging to other users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete operations.
     * Prevents modifying or deleting documents that do not exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * Validates that a user is creating their own root user document and that the
     * internal 'id' field correctly matches their UID for relational integrity.
     */
    function isCreatingOwnUserDoc(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates that a user is updating their own user document and that the
     * critical, immutable 'id' field is not being changed.
     */
    function isMaintainingOwnUserDoc(userId) {
      // On update, `request.resource.data` represents the final merged data.
      // This rule ensures the `id` field remains unchanged.
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }
    
    /**
     * Validates that a user is creating a document in their own subcollection
     * and that the internal 'userId' field correctly points back to them.
     */
    function isCreatingOwnSubDoc(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }
    
    /**
     * Validates that a user is updating a document in their own subcollection
     * and that the immutable 'userId' field is not being changed.
     */
    function isMaintainingOwnSubDoc(userId) {
      // This rule ensures the relational link (`userId`) to the parent cannot be modified.
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.id;
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to a user's primary profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user can create their own user profile document.
     * @deny (list) No user, authenticated or not, can list all documents in the `/users` collection.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isCreatingOwnUserDoc(userId);
      allow update: if isMaintainingOwnUserDoc(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's resume documents.
     * @path /users/{userId}/resumes/{resumeId}
     * @allow (get) An authenticated user can read a resume document they own.
     * @deny (get) An authenticated user cannot read a resume document owned by another user.
     * @principle Enforces strict ownership for all operations within a user's private subcollection.
     */
    match /users/{userId}/resumes/{resumeId} {
      allow get, list: if isOwner(userId);
      allow create: if isCreatingOwnSubDoc(userId);
      allow update: if isMaintainingOwnSubDoc(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's AI Mentor data.
     * @path /users/{userId}/aiMentors/{aiMentorId}
     * @allow (create) An authenticated user can create an AI Mentor document in their own profile.
     * @deny (update) An authenticated user cannot update an AI Mentor document owned by another user.
     * @principle Enforces strict ownership for all operations within a user's private subcollection.
     */
    match /users/{userId}/aiMentors/{aiMentorId} {
      allow get, list: if isOwner(userId);
      allow create: if isCreatingOwnSubDoc(userId);
      allow update: if isMaintainingOwnSubDoc(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's Career Dashboard data.
     * @path /users/{userId}/careerDashboards/{careerDashboardId}
     * @allow (delete) An authenticated user can delete a career dashboard they own.
     * @deny (delete) An authenticated user cannot delete another user's career dashboard.
     * @principle Enforces strict ownership for all operations within a user's private subcollection.
     */
    match /users/{userId}/careerDashboards/{careerDashboardId} {
      allow get, list: if isOwner(userId);
      allow create: if isCreatingOwnSubDoc(userId);
      allow update: if isMaintainingOwnSubDoc(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}